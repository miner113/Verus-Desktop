name: Build Verus Desktop

on:
  push:
    branches: [main, master, release/*]
  pull_request:
    branches: [master]

env:
  DEFAULT_VERUSCOIN_BRANCH: release
  VERUS_VERSION: 1.2.12-2
  VERUSCOIN_VERSION: 1.2.12-2
  KOMODO_VERSION: 0.9.0
  KOMODO_DOWNLOAD_URL: https://github.com/KomodoPlatform/komodo/releases/download
  PIRATE_VERSION: 5.9.0
  PIRATE_DOWNLOAD_URL: https://github.com/PirateNetwork/pirate/releases/download
  BINARY_SOURCE: VerusCoin
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
   build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Node.js 16
      uses: actions/setup-node@v4
      with:
        node-version: '16.20.2'
        
    - name: Install yarn
      run: npm install -g yarn
        
    - name: Build React GUI
      run: |
        cd gui/Verus-Desktop-GUI/react
        yarn install
        yarn run build
        cd ../../..
        
    - name: Setup API keys (Windows)
      shell: pwsh
      run: |
        (Get-Content keys/infura.js) -replace "process.env.INFURA_PROJECT_ID", "'${{ secrets.INFURA_PROJECT_ID }}'" | Set-Content keys/infura.js
        (Get-Content keys/etherscan.js) -replace "process.env.ETHERSCAN_API_KEY", "'${{ secrets.ETHERSCAN_KEY }}'" | Set-Content keys/etherscan.js
        
    - name: Install main dependencies
      run: yarn install
      
    - name: Apply patches and build dependencies
      run: |
        yarn run patch-package
        cd node_modules/react-terminal
        yarn install
        yarn run build
        cd ../..
      
    - name: Build plugins
      run: |
        git clone https://github.com/VerusCoin/verus-login-consent-client.git
        cd verus-login-consent-client
        yarn install
        yarn run build
        if (!(Test-Path "../assets/plugins/builtin/verus-login-consent-client")) {
          New-Item -ItemType Directory -Path "../assets/plugins/builtin/verus-login-consent-client" -Force
        }
        Copy-Item -Path "build/*" -Destination "../assets/plugins/builtin/verus-login-consent-client/" -Recurse
        cd ..
        Remove-Item -Path "verus-login-consent-client" -Recurse -Force
        
        git clone https://github.com/VerusCoin/verus-pbaas-visualizer.git
        cd verus-pbaas-visualizer
        yarn install
        yarn run build
        if (!(Test-Path "../assets/plugins/builtin/verus-pbaas-visualizer")) {
          New-Item -ItemType Directory -Path "../assets/plugins/builtin/verus-pbaas-visualizer" -Force
        }
        Copy-Item -Path "build/*" -Destination "../assets/plugins/builtin/verus-pbaas-visualizer/" -Recurse
        cd ..
        Remove-Item -Path "verus-pbaas-visualizer" -Recurse -Force
        
    - name: Build application
      run: yarn run dist-win
      
    - name: Check built artifacts
      run: |
        echo "=== Windows Build Artifacts ==="
        dir dist\
        echo "=== File Sizes ==="
        Get-ChildItem dist\ | ForEach-Object { Write-Output "$($_.Name): $([math]::Round($_.Length/1MB, 2)) MB" }
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-desktop-windows
        path: dist/
        retention-days: 30
