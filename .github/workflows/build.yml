name: Build Verus Desktop

on:
  push:
    branches: [main, master, release/*]
  pull_request:
    branches: [master]

env:
  DEFAULT_VERUSCOIN_BRANCH: release
  VERUS_VERSION: 1.2.12-2
  VERUSCOIN_VERSION: 1.2.12-2
  BINARY_SOURCE: VerusCoin
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  build-windows-on-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, ia32]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Node.js 16
      uses: actions/setup-node@v4
      with:
        node-version: '16.20.2'
        
    - name: Install Wine and dependencies for Windows cross-compilation
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          wine64 wine32 development-tools \
          libgtk-3-dev libnotify-dev libgconf-2-4 \
          libnss3 libxss1 libasound2 libxtst6 \
          xvfb libsecret-1-dev fakeroot rpm \
          mono-complete nsis
        
    - name: Install yarn
      run: npm install -g yarn
        
    - name: Build React GUI
      run: |
        cd gui/Verus-Desktop-GUI/react
        yarn install
        yarn run build
        cd ../../..
        
    - name: Setup API keys
      run: |
        sed -i "s/process.env.INFURA_PROJECT_ID/'${{ secrets.INFURA_PROJECT_ID }}'/g" keys/infura.js
        sed -i "s/process.env.ETHERSCAN_API_KEY/'${{ secrets.ETHERSCAN_KEY }}'/g" keys/etherscan.js
        
    - name: Install main dependencies
      run: yarn install
      
    - name: Apply patches and build dependencies
      run: |
        yarn run patch-package
        cd node_modules/react-terminal
        yarn install
        yarn run build
        cd ../..
      
    - name: Build plugins
      run: |
        git clone https://github.com/VerusCoin/verus-login-consent-client.git
        cd verus-login-consent-client
        yarn install
        yarn run build
        mkdir -p ../assets/plugins/builtin/verus-login-consent-client
        cp -r build/* ../assets/plugins/builtin/verus-login-consent-client/
        cd ..
        rm -rf verus-login-consent-client
        
        git clone https://github.com/VerusCoin/verus-pbaas-visualizer.git
        cd verus-pbaas-visualizer
        yarn install
        yarn run build
        mkdir -p ../assets/plugins/builtin/verus-pbaas-visualizer
        cp -r build/* ../assets/plugins/builtin/verus-pbaas-visualizer/
        cd ..
        rm -rf verus-pbaas-visualizer
        
    - name: Setup Windows binaries directory
      run: |
        mkdir -p assets/bin/win64/verusd
        mkdir -p assets/bin/win64/komodod
        mkdir -p assets/bin/win64/pirated
        
    - name: Build Windows application
      run: |
        export DISPLAY=:99.0
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
        if [ "${{ matrix.arch }}" = "x64" ]; then
          yarn run dist-win --x64
        else
          yarn run dist-win --ia32
        fi
      
    - name: Check built artifacts
      run: |
        echo "=== Windows Build Artifacts (${{ matrix.arch }}) ==="
        ls -la dist/
        echo "=== File Sizes ==="
        du -h dist/*
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-desktop-windows-${{ matrix.arch }}
        path: dist/
        retention-days: 30

 
