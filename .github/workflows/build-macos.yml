name: Build Verus Desktop Macos

on:
  push:
    branches: [main, master, release/*]
  pull_request:
    branches: [master]

env:
  DEFAULT_VERUSCOIN_BRANCH: release
  VERUS_VERSION: 1.2.12-2
  VERUSCOIN_VERSION: 1.2.12-2
  KOMODO_VERSION: 0.9.0
  KOMODO_DOWNLOAD_URL: https://github.com/KomodoPlatform/komodo/releases/download
  PIRATE_VERSION: 5.9.0
  PIRATE_DOWNLOAD_URL: https://github.com/PirateNetwork/pirate/releases/download
  BINARY_SOURCE: VerusCoin

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      KOMODO_CLI_PACKAGE: komodo-${KOMODO_VERSION}-mac.zip
      KOMODO_CLI_SHA256: 1a092af97b34f4e2ea99b95a91599fc4fdca3881c7e3afa468a5df043a460694
      PIRATE_CLI_PACKAGE: pirate-cli-MacOS-v${PIRATE_VERSION}.zip
      PIRATE_CLI_SHA256: c20a761c36e494cd2b19237162881bb0dcdae24e6eec996072cc5ee7135e8362
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Node.js 18 for macOS
      uses: actions/setup-node@v4
      with:
        node-version: '18.20.4'
        cache: 'yarn'
        
    - name: Install system dependencies
      run: |
        # Устанавливаем необходимые системные зависимости
        brew install python@3.9 || true
        export PATH="/opt/homebrew/opt/python@3.9/bin:$PATH"
        
    - name: Install yarn
      run: npm install -g yarn
        
    - name: Build React GUI with legacy OpenSSL
      run: |
        cd gui/Verus-Desktop-GUI/react
        yarn install --frozen-lockfile
        NODE_OPTIONS="--openssl-legacy-provider" yarn run build
        cd ../../..
        
    - name: Setup binaries directory
      run: |
        mkdir -p assets/bin/osx/verusd
        mkdir -p assets/bin/osx/komodod
        mkdir -p assets/bin/osx/pirated
        
    - name: Setup API keys
      run: |
        sed -i '' "s/process.env.INFURA_PROJECT_ID/'${{ secrets.INFURA_PROJECT_ID }}'/g" keys/infura.js
        sed -i '' "s/process.env.ETHERSCAN_API_KEY/'${{ secrets.ETHERSCAN_KEY }}'/g" keys/etherscan.js
        
    - name: Install main dependencies
      run: yarn install
      
    - name: Build plugins with sass workaround
      run: |
        # Сначала клонируем репозитории
        git clone https://github.com/VerusCoin/verus-login-consent-client.git
        git clone https://github.com/VerusCoin/verus-pbaas-visualizer.git
        
        # Пытаемся заменить node-sass на sass в verus-login-consent-client
        cd verus-login-consent-client
        if [ -f "package.json" ]; then
          echo "Fixing node-sass dependency in verus-login-consent-client..."
          # Заменяем node-sass на sass если он есть
          if grep -q "node-sass" package.json; then
            yarn remove node-sass || true
            yarn add -D sass || true
          fi
          yarn install --ignore-engines --ignore-scripts || echo "Install failed but continuing..."
          NODE_OPTIONS="--openssl-legacy-provider" yarn run build || echo "Build failed but continuing..."
          mkdir -p ../assets/plugins/builtin/verus-login-consent-client
          if [ -d "build" ]; then
            cp -r build/* ../assets/plugins/builtin/verus-login-consent-client/ || echo "Copy failed"
          fi
        fi
        cd ..
        
        # Собираем verus-pbaas-visualizer
        cd verus-pbaas-visualizer
        if [ -f "package.json" ]; then
          echo "Building verus-pbaas-visualizer..."
          yarn install --ignore-engines --ignore-scripts || echo "Install failed but continuing..."
          NODE_OPTIONS="--openssl-legacy-provider" yarn run build || echo "Build failed but continuing..."
          mkdir -p ../assets/plugins/builtin/verus-pbaas-visualizer
          if [ -d "build" ]; then
            cp -r build/* ../assets/plugins/builtin/verus-pbaas-visualizer/ || echo "Copy failed"
          fi
        fi
        cd ..
        
        # Очищаем
        rm -rf verus-login-consent-client verus-pbaas-visualizer
        
    - name: Build macOS application
      run: |
        export USE_HARD_LINKS=false
        yarn run dist
      
    - name: Check built artifacts
      run: |
        echo "=== macOS Build Artifacts ==="
        ls -la dist/
        echo "=== File Details ==="
        file dist/* || true
        echo "=== File Sizes ==="
        du -h dist/*
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verus-desktop-macos
        path: dist/
        retention-days: 30